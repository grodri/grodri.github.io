---
layout: default
section: multilevel
tab: "Bayes"
pager: true
---

<h2 id="gibbs-sampling-using-jags">Gibbs Sampling Using JAGS</h2>
<p>JAGS is “Just Another Gibbs Sampler”, a program for the analysis of
Bayesian models using MCMC. It uses essentially the same model language
as WinBUGS or OpenBUGS. It works closely with R via <code>rjags</code>,
so that’s what I will use here. Let’s try it.</p>
<div style="border-left:2px solid #3366cc; padding-left:1em">
<p>Start by downloading JAGS from <a
href="https://sourceforge.net/projects/mcmc-jags/files">here</a>. Then
in R <code>install.packages("rjags")</code>, which will also install
<code>coda</code>.</p>
</div>
<p>We start by writing our model and saving it to a file, here
<code>hosp.bugs</code>. This is exactly the same code used for WinBUGS
<a href="hospBUGS">here</a>.</p>
<pre><code>    model {
        # N observations
        for (i in 1:N) {
            hospital[i] ~ dbern(p[i])
            logit(p[i]) &lt;- bcons + bloginc*loginc[i] + bdistance*distance[i] + 
                bdropout*dropout[i] + bcollege*college[i] + u[group[i]] 
        }
        # M groups
        for (j in 1:M) {
            u[j] ~ dnorm(0,tau)
        }
        # Priors
        bcons     ~ dnorm(0.0,1.0E-6)
        bloginc   ~ dnorm(0.0,1.0E-6)
        bdistance ~ dnorm(0.0,1.0E-6)
        bdropout  ~ dnorm(0.0,1.0E-6)
        bcollege  ~ dnorm(0.0,1.0E-6)
        # Hyperprior
        tau ~ dgamma(0.001,0.001)
    }</code></pre>
<p>Next we need the data, which need to be in a list. We will read them
into R just like we did <a href="hospmle">here</a>, and then produce a
list with the number of observations (N) and groups (M), the outcome
<code>hospital</code> and the predictors <code>loginc</code>,
<code>distance</code>, <code>dropout</code> and <code>college</code>. We
also need <code>mother</code>, which groups the births.</p>
<pre class='r'>> hosp &lt;- read.table("https://data.princeton.edu/pop510/hospital.dat", 
+     header = FALSE)
> names(hosp) &lt;- c("hosp","loginc","distance","dropout","college","mother")
> hosp_data &lt;- list(N = 1060, M = 501, hospital = hosp$hosp, 
+     loginc=hosp$loginc, distance=hosp$distance, dropout=hosp$dropout, 
+     college=hosp$college, group=hosp$mother)
</pre>
<p>The other thing we need are initial values. We use two lists, one for
each chain, with values scattered around the mle’s. The random effects
are generated by JAGS.</p>
<pre class='r'>> hosp_inits= list(
+   list(bcons=-2.5, bloginc=0.50, bdistance=-0.05, bdropout=-1.6, bcollege=0.7, tau=0.8),
+   list(bcons=-2.8, bloginc=0.40, bdistance=-0.08, bdropout=-1.4, bcollege=0.9, tau=1.2)
+ )
</pre>
<p>We are now ready. We load the <code>rjags</code> library and then
compile the model by calling the <code>jags.model()</code> function</p>
<pre class='r'>> library(rjags)
> model &lt;- jags.model("hosp.bugs", data = hosp_data, inits =hosp_inits, n.chains=2)
Compiling model graph
   Resolving undeclared variables
   Allocating nodes
Graph information:
   Observed stochastic nodes: 1060
   Unobserved stochastic nodes: 507
   Total graph size: 9884

Initializing model
</pre>
<p>With the model ready we run a burn-in of 1000 iterations using
<code>update()</code></p>
<pre class='r'>> update(model, n.iter = 1000)
</pre>
<p>We can now run a further 5000 iterations monitoring the parameters of
interest. We use <code>coda.samples()</code>, which is a wrapper around
<code>jags.samples()</code>.</p>
<pre class='r'>> samples &lt;- coda.samples(model, 
+   variable.names = c("bcons","bloginc","bdistance","bdropout","bcollege","tau"), 
+   n.iter = 5000)
</pre>
<p>We can then summarize our samples, an object of class
<code>mcmc.list</code>.</p>
<pre class='r'>> summary(samples)

Iterations = 2001:7000
Thinning interval = 1 
Number of chains = 2 
Sample size per chain = 5000 

1. Empirical mean and standard deviation for each variable,
   plus standard error of the mean:

              Mean      SD  Naive SE Time-series SE
bcollege   1.05639 0.41282 0.0041282      0.0111317
bcons     -3.38305 0.50784 0.0050784      0.0508158
bdistance -0.07783 0.03281 0.0003281      0.0009328
bdropout  -2.04407 0.26939 0.0026939      0.0110984
bloginc    0.56473 0.07779 0.0007779      0.0072873
tau        0.63297 0.20605 0.0020605      0.0165996

2. Quantiles for each variable:

             2.5%      25%      50%      75%    97.5%
bcollege   0.2724  0.77612  1.04772  1.32113  1.89939
bcons     -4.4508 -3.70556 -3.35383 -3.02013 -2.49771
bdistance -0.1419 -0.09954 -0.07816 -0.05561 -0.01281
bdropout  -2.5991 -2.21880 -2.02912 -1.85405 -1.54798
bloginc    0.4204  0.51167  0.56040  0.61474  0.72825
tau        0.3291  0.48709  0.59592  0.74515  1.13837
</pre>
<p>The class also has a <code>plot()</code> method to produce the usual
trace and density plots. R will pause between plots, but R Studio does
not.</p>
<p>A good way to do a trace plot is to change the aspect ratio. I had
good results with the following code</p>
<pre class='r'>> library(dplyr)
> library(ggplot2)
> mcmc &lt;- data.frame(rbind(samples[[1]], samples[[2]]))
> mcmc &lt;- mutate(mcmc, 
+   chain=factor(rep(c(1,2),c(5000,5000))),
+   iteration = rep(1:5000, 2))
> r &lt;- 5000 / (5*range(mcmc$bdistance) %*% c(-1,1) )
> ggplot(mcmc, aes(iteration, bdistance, color=chain)) + geom_line() + 
+   coord_fixed(ratio=r)
> ggsave("jagsFig1.png", width=500/72, height=400/72, dpi=72)
</pre>
<p>Which produces this plot:</p>
<p><img src="jagsFig1.png" class="img-responsive img-center r" /></p>
<!-- 
https://staffblogs.le.ac.uk/bayeswithstata/2014/11/21/jags-with-stata/
-->
<h2 id="references">References</h2>
<p>Lunn D, Spiegelhalter D, Thomas A, Best N. (2009) The BUGS project:
Evolution, critique and future directions. <em>Statistics in
Medicine</em>, <strong>28</strong>:3049-67.</p>
<p>Plummer M, Best N, Cowles K, Vines K (2006). CODA: Convergence
Diagnosis and Output Analysis for MCMC, <em>R News</em>, 6:7-11. <a
href="https://cran.r-project.org/doc/Rnews/Rnews_2006-1.pdf">CRAN</a></p>
<p>Plummer, M, A. Stukalov, and M. Denwood (2022). Bayesian Graphical
Models using MCMC. An R vignette. <a
href="https://cran.r-project.org/web/packages/rjags/rjags.pdf">CRAN</a></p>
